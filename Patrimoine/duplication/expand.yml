entities:
    menage:
        fields:
            # period and id are implicit
            - pond:        float
            - pondfin:     {type: float, initialdata: false}
            - toclone:     {type: bool, initialdata: false}
            - clone_id : {type: int, initialdata: false}
            
        links:
            persons: {type: one2many, target: person, field: res}

        processes:

            rien: 
                - show('empty menages:', grpsum(toclone))
            check:
                - show('empty menages:', grpsum(countlink(persons) == 0))

            expand:
                - minpond: grpmin(pond)
                # - show('la plus petite ponderation est:' grpmin(minpond))
                - last_non_clone_id: grpmax(id)
                - toclone: pond > 2*minpond
                # clone all menages with a weight > 1
                - clone_id: clone(toclone)
                
                # modify the weight:
                # for the original menages: (weight + 1) / 2
                # for the new (cloned) menage: weight / 2
                - is_clone: id > last_non_clone_id
                - pondfin: if(toclone,
                             pond/2,
                             pond)
                - pondfin: if(id>last_non_clone_id,
                             pondfin/2,
                             pondfin)                           
                               
    person:
        fields:
            - age:    int
            - sexe:   int
            - res:    int
            - pere:   int
            - mere:   int
            - conjoint: int
            - clone_id : {type: int, initialdata: false}
  
         
        links:
            menage:     {type: many2one, target: menage, field: res}
            mater:      {type: many2one, target: person, field: mere}
            pater:      {type: many2one, target: person, field: pere}
            conj:       {type: many2one, target: person, field: conjoint}
            children1:  {type: one2many, target: person, field: mere}
            children2:  {type: one2many, target: person, field: pere}
            duplic:     {type: many2one, target: person, field: clone_id}

        processes:
        
            rien: 0
            # check:
                # - show('total population:', grpsum(fweight))
                # - show('min/max weight:', grpmin(fweight), grpmax(fweight))
                # - show('menage weight problems:',
                       # grpcount((hh_id != -1) and (menage.weight != fweight)))
                # - show('menage weight -1 problems:',
                       # grpcount((hh_id == -1)))
                # - show('partner weight problems:',
                       # grpcount((partner_id != -1) and (partner.fweight != fweight)))
                # - show('mother weight problems:',
                       # grpcount((m_id != -1) and (mother.fweight != fweight)))

            # shrink:
                # - agegroup: if(age < 15, 0, if(age >= 65, 13, trunc(age / 5))) * 5
                # - show(groupby(agegroup, gender, expr=grpsum(weight)))
                # - show(groupby(agegroup, gender, expr=grpsum(weight), percent=True))
                # - show('min/max weight:', grpmin(weight), grpmax(weight))
# #                - fweight_old: trunc(round(fweight / grpmin(fweight)))
# #                - show('min/max shrinked weight (int source):', grpmin(fweight_old), grpmax(fweight_old))
# #                - show(groupby(trunc(age / 10) * 10, gender, expr=grpsum(fweight_old)))
# #                - show(groupby(trunc(age / 10) * 10, gender, expr=grpsum(fweight_old), percent=True))
                # - fweight: trunc(round(weight / grpmin(weight)))
                # - show('min/max shrinked weight:', grpmin(fweight), grpmax(fweight))
                # - show(groupby(agegroup, gender, expr=grpsum(fweight)))
                # - show(groupby(agegroup, gender, expr=grpsum(fweight), percent=True))

            expand:
                - last_non_clone_id: grpmax(id)
                - toclone: menage.toclone
                - clone_id: clone(toclone)

                - is_clone: id > last_non_clone_id



                - res: if(is_clone, menage.clone_id, res)
                - mere: if(is_clone, mater.clone_id, mere)
                - pere: if(is_clone, pater.clone_id, pere)
                - conjoint: if(is_clone, conj.clone_id, conjoint)
                - duplic.clone_id : 0       

simulation:
    init:
        # - person: [shrink]
        # checks
        - menage: [check,expand]
        # - person: [check]

        # # pass 1: weight up to 2
        # - menage: [expand]
        - person: [expand]
        # # pass 2: weights up to 4
        # - menage: [expand]
        # - person: [expand]
        # # pass 3: weights up to 8
        # - menage: [expand]
        # - person: [expand]
        # # pass 4: weights up to 16
        # - menage: [expand]
        # - person: [expand]
        # # pass 5: weights up to 32
        # - menage: [expand]
        # - person: [expand]
        # # pass 6: weights up to 64
        # - menage: [expand]
        # - person: [expand]
        # # pass 7: weights up to 128
        # - menage: [expand]
        # - person: [expand]

        # # checks
        # - menage: [weight, check]
        # - person: [check]
    processes:
        - menage: [rien]
        - person: [rien]   
    input:
        file: simple2009.h5

    output:
        file: data_expanded.h5

    start_period: 2010   # first simulated period
    periods: 0